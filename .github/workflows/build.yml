#
# Copyright (c) 2021-present, Trail of Bits, Inc.
# All rights reserved.
#
# This source code is licensed in accordance with the terms specified in
# the LICENSE file found in the root directory of this source tree.
#

name: Build

on:
  push:
    branches:
      - 'master'

    tags:
      - '*'

  pull_request:
    branches:
      - '*'

jobs:
  build_linux:
    runs-on: ubuntu-22.04
    timeout-minutes: 15

    steps:
      - name: Clone the vast repository
        uses: actions/checkout@v3
        with:
          submodules: true
          fetch-depth: 1

      - name: Build and run dev container task
        uses: devcontainers/ci@v0.2
        with:
          runCmd: |
            export CC=clang-15
            export CXX=clang++-15

            sudo cmake --preset ninja-multi-default --toolchain ./cmake/lld.toolchain.cmake \
              -D CMAKE_VERBOSE_MAKEFILE=True \
              -DCMAKE_PREFIX_PATH=${CMAKE_PREFIX_PATH} \
              -DLLVM_EXTERNAL_LIT=${LLVM_EXTERNAL_LIT} || exit 1

            sudo cmake --build --preset ninja-rel -j $(nproc) || exit 1
            sudo cmake --build --preset ninja-deb -j $(nproc) || exit 1

            sudo ctest --preset ninja-deb --output-on-failure || exit 1

            sudo cpack -G TXZ --config ./builds/ninja-multi-default/CPackConfig.cmake || exit 1

      - name: Extract package
        working-directory: ${{ steps.build_paths.outputs.install }}
        run: |
          mkdir vast
          tar -xf ./builds/ninja-multi-default/package/*.tar.xz -C vast --strip-components=1

      # - name: Test codegen example
      #   working-directory: ${{ steps.build_paths.outputs.source }}/vast/example/codegen

      #   run: |
      #     LLVM_INSTALL_DIR="${{ steps.build_paths.outputs.install }}/llvm"
      #     VAST_CMAKE_DIR="${{ steps.build_paths.outputs.install }}/vast/lib/cmake/vast/"

      #     cmake -G Ninja -B build -S . \
      #       -D LLVM_INSTALL_DIR=${LLVM_INSTALL_DIR} \
      #       -D VAST_CMAKE_DIR=${VAST_CMAKE_DIR} \
      #       -D CMAKE_BUILD_TYPE=Release \
      #       -D CMAKE_VERBOSE_MAKEFILE=True \
      #       -D CMAKE_C_COMPILER=${{ steps.envvars.outputs.cc }} \
      #       -D CMAKE_CXX_COMPILER=${{ steps.envvars.outputs.cxx }}

      #     cmake --build build

      # - name: Upload vast package artifact
      #   uses: actions/upload-artifact@v3
      #   with:
      #     name: vast-${{ matrix.config.arch }}-${{ matrix.config.os }}
      #     path: ${{ steps.build_paths.outputs.build }}/package/
      #     retention-days: 30

